# üöÄ Redis Cluster on Docker

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è **Redis Cluster** –≤ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–∏ —Å –ø–æ–ª–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ **Makefile**.

–ö–ª–∞—Å—Ç–µ—Ä —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ **10 –Ω–æ–¥** (`redis-node1` ‚Ä¶ `redis-node10`) –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –ø–æ–¥–∫–ª—é—á–∞—é—â–∏—Ö—Å—è —á–µ—Ä–µ–∑ –æ–±—â—É—é –≤–Ω–µ—à–Ω—é—é Docker-—Å–µ—Ç—å.

---

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
.
‚îú‚îÄ‚îÄ .gitignore                 # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç runtime-–¥–∞–Ω–Ω—ã–µ Redis
‚îú‚îÄ‚îÄ Makefile                   # üÜï –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∫–ª–∞—Å—Ç–µ—Ä–∞
‚îú‚îÄ‚îÄ create-cluster.sh          # –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
‚îú‚îÄ‚îÄ reset-cluster.sh           # –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
‚îú‚îÄ‚îÄ docker-compose.yml         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Å–µ—Ö 10 –Ω–æ–¥
‚îú‚îÄ‚îÄ README.md                  # –≠—Ç–æ—Ç —Ñ–∞–π–ª
‚îî‚îÄ‚îÄ data/                      # (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ) —Ç–æ–º–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–¥
    ‚îú‚îÄ‚îÄ redis-node1/
    ‚îú‚îÄ‚îÄ redis-node2/
    ‚îî‚îÄ‚îÄ ...
```

---

## ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ Makefile):

1Ô∏è‚É£ –ü–æ—Å–º–æ—Ç—Ä–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

```bash
make help
```

2Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏ –∫–ª–∞—Å—Ç–µ—Ä –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:

```bash
make up
```

3Ô∏è‚É£ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π –∫–ª–∞—Å—Ç–µ—Ä**:

```bash
make create-cluster
```

### üìã –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ Docker Compose):

1Ô∏è‚É£ –°–æ–∑–¥–∞–π –≤–Ω–µ—à–Ω—é—é —Å–µ—Ç—å:

```bash
make network-create
```

2Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:

```bash
docker compose up -d
```

3Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π –∫–ª–∞—Å—Ç–µ—Ä:

```bash
bash create-cluster.sh
```

---

## üõ† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–º

### üìä –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

```bash
make status          # –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
make logs            # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
make check-cluster   # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞
make info            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ
make test            # –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```

### ‚ôªÔ∏è –°–±—Ä–æ—Å –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞:

```bash
make reset           # –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
make reset-force     # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
```

–ö–æ–º–∞–Ω–¥–∞ `reset` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
* –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –¥–∞–Ω–Ω—ã–º–∏
* –û—á–∏—â–∞–µ—Ç –ø–∞–ø–∫—É `./data`
* –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä –∑–∞–Ω–æ–≤–æ

### üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
make cli             # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis CLI
make monitor         # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ Redis
```

---

## üåê –°–µ—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

–ö–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ **–≤–Ω–µ—à–Ω–µ–π** –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏:

```yaml
networks:
  redis-cluster-net:
    name: redis-cluster-net
    external: true  # üÜï –í–Ω–µ—à–Ω—è—è —Å–µ—Ç—å
```

### üîó –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ç—å—é:

```bash
make network-create  # –°–æ–∑–¥–∞—Ç—å –≤–Ω–µ—à–Ω—é—é —Å–µ—Ç—å
make network-info    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏
make network-remove  # –£–¥–∞–ª–∏—Ç—å —Å–µ—Ç—å (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
```

### üì± –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π:

–ü–æ–¥–∫–ª—é—á–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –ª—é–±—É—é –Ω–æ–¥—É:

```bash
docker run --network redis-cluster-net your-app
```

–°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
```ini
tcp://redis-node1:6379?prefix=my_project:
```

---

## üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –Ω–æ–¥—ã:

1. –û–±–Ω–æ–≤–∏ `docker-compose.yml`, –¥–æ–±–∞–≤–∏–≤ –Ω–æ–≤—É—é –Ω–æ–¥—É
2. –ò—Å–ø–æ–ª—å–∑—É–π Makefile:

   ```bash
   make add-node NODE=redis-node11:6379
   ```

### üîÑ –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤:

```bash
make reshard         # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
```

### ‚ûñ –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–¥—ã:

```bash
make info            # –ü–æ–ª—É—á–∏ NODE_ID
make remove-node NODE_ID=<node-id>
```

---

## üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏

### üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤:

```bash
make backup          # –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –≤ ./backups/
```

–ë—ç–∫–∞–ø –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ Redis –∏–∑ –ø–∞–ø–∫–∏ `./data/` –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π.

### üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞:

```bash
make restore BACKUP=./backups/redis-backup-XXXXXXXX.tar.gz
```

### üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:

```bash
make clean           # –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ volumes
make clean-all       # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è –æ–±—Ä–∞–∑—ã)
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis:

- **–í–µ—Ä—Å–∏—è**: Redis 7.2-alpine
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: 10 –Ω–æ–¥ (5 –º–∞—Å—Ç–µ—Ä–æ–≤ + 5 —Ä–µ–ø–ª–∏–∫)
- **–ü–∞–º—è—Ç—å**: 2GB –Ω–∞ –Ω–æ–¥—É —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π `allkeys-lru`
- **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: AOF + RDB —Å–Ω–∞–ø—à–æ—Ç—ã
- **–°–µ—Ç—å**: –í–Ω–µ—à–Ω—è—è Docker-—Å–µ—Ç—å `redis-cluster-net`

### üÜï –£–ª—É—á—à–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏:

- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞**: –∫–∞–∂–¥–∞—è –Ω–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∞–Ω–æ–Ω—Å–∏—Ä—É–µ—Ç —Å–≤–æ–π IP
- ‚úÖ **Makefile –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**: 20+ –∫–æ–º–∞–Ω–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–º
- ‚úÖ **–í–Ω–µ—à–Ω—è—è —Å–µ—Ç—å**: —É–ª—É—á—à–µ–Ω–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –±—ç–∫–∞–ø–æ–≤**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- ‚úÖ **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### üìä –ü–æ—Ä—Ç—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```
redis-node1  -> localhost:7001
redis-node2  -> localhost:7002
redis-node3  -> localhost:7003
redis-node4  -> localhost:7004
redis-node5  -> localhost:7005
redis-node6  -> localhost:7006
redis-node7  -> localhost:7007
redis-node8  -> localhost:7008
redis-node9  -> localhost:7009
redis-node10 -> localhost:7010
```

---

## ‚ùì FAQ

**üöÄ –ö–∞–∫ –±—ã—Å—Ç—Ä–æ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É?**
```bash
make up && make create-cluster
```

**üîÑ –ö–∞–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä?**
```bash
make reset
```

**üì± –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π?**
‚úÖ –î–∞! –ò—Å–ø–æ–ª—å–∑—É–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ `prefix` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ–±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∫–ª—é—á–∏.

**üéØ –ö –∫–∞–∫–æ–π –Ω–æ–¥–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è?**
‚úÖ –ö –ª—é–±–æ–π. Redis Cluster –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –Ω—É–∂–Ω—É—é –Ω–æ–¥—É.

**üíæ –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ `data/`?**
Runtime-–¥–∞–Ω–Ω—ã–µ (`dump.rdb`, `appendonly.aof`, `nodes.conf`) ‚Äî **–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –≤ Git**.

**üåê –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤–Ω–µ—à–Ω–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?**
```bash
docker run --network redis-cluster-net your-app
```

**üìã –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã?**
```bash
make help
```

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

* [Redis Cluster ‚Äî –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://redis.io/docs/management/scaling/)
* [redis-cli ‚Äî –†–∞–±–æ—Ç–∞ —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º](https://redis.io/docs/manual/scaling/#using-the-redis-cli-tool)
* [Docker Compose ‚Äî –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ç–∏](https://docs.docker.com/compose/networking/#use-a-pre-existing-network)
